--------------------------------
-- AGGIORNAMENTO SITAT/VIGILANZA
-- Database: DB2
------------------------------



------------------------------
-- SITATORT 2.7.2
--------------------------

------------------------------------------------------------------------------------------------
------------------------         MODIFICA STRUTTURA TABELLE              ------------------------
------------------------------------------------------------------------------------------------

ALTER TABLE SITATORT.W9LOTT ADD COLUMN DATA_PUBBLICAZIONE TIMESTAMP;
ALTER TABLE SITATORT.W9LOTT ADD COLUMN DATA_CONSULTA_GARA TIMESTAMP;
ALTER TABLE SITATORT.W9LOTT ADD COLUMN EXSOTTOSOGLIA VARCHAR(1);

CREATE TABLE SITATORT.W9LOADER_APPALTO_USR (
	SYSCON NUMERIC(12) NOT NULL,
	SIMOGUSER VARCHAR(100),
	SIMOGPASS VARCHAR(100)
);
ALTER TABLE SITATORT.W9LOADER_APPALTO_USR ADD CONSTRAINT W9LOADER_APPALTO_USR_PK PRIMARY KEY (SYSCON);

ALTER TABLE SITATORT.W9FASI ADD COLUMN DAEXPORT VARCHAR(1);
ALTER TABLE SITATORT.W9XML ADD COLUMN IDFLUSSO NUMERIC(10);
ALTER TABLE SITATORT.W9XML ADD XML CLOB(10 M);

ALTER TABLE SITATORT.UFFINT ALTER COLUMN CFEIN SET DATA TYPE VARCHAR(20);
ALTER TABLE SITATORT.W9FLUSSI ALTER COLUMN CFSA SET DATA TYPE VARCHAR(16);


REORG TABLE SITATORT.W9LOTT;
REORG TABLE SITATORT.W9FASI;
REORG TABLE SITATORT.W9XML;
REORG TABLE SITATORT.UFFINT;
REORG TABLE SITATORT.W9FLUSSI;

--- View V_RUOLOTECNICO: drop and create
DROP VIEW SITATORT.V_RUOLOTECNICO;

CREATE VIEW SITATORT.V_RUOLOTECNICO as
SELECT I.CODGARA, I.CODLOTT, I.ID_RUOLO, I.CODTEC, G.CODEIN
  FROM SITATORT.W9INCA I, SITATORT.TECNI T, SITATORT.W9GARA G
 WHERE I.ID_RUOLO IN (15,16,17)
   AND I.CODTEC = T.CODTEC
   AND T.CGENTEI = G.CODEIN
   AND I.CODGARA = G.CODGARA
UNION
SELECT G.CODGARA, L.CODLOTT, 14 AS ID_RUOLO, G.RUP AS CODTEC, G.CODEIN
  FROM SITATORT.W9GARA G LEFT OUTER JOIN SITATORT.W9LOTT L on G.CODGARA = L.CODGARA
  JOIN SITATORT.TECNI T ON G.RUP = T.CODTEC AND G.CODEIN = T.CGENTEI
 WHERE G.RUP IS NOT NULL;


------------------------------------------------------------------------------------------------
------------------------         MODIFICA AI DATI          -------------------------------------
------------------------------------------------------------------------------------------------


--- C0CAMPI
INSERT INTO SITATORT.C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) values (0,'E',null,'DATA_PUBBLICAZIONE.W9LOTT.W9','W9DPUBBLICAZ','Data pubblicazione','Data pubblicazione','A10',null,'DATA_ELDA','Data pubblicazione');
INSERT INTO SITATORT.C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) values (0,'P',null,'XML.W9XML.W9','W9FILEXML','File XML','File XML','A2000',null,'BLOB','File XML');
INSERT INTO SITATORT.C0CAMPI (COC_CONTA,C0C_TIP,C0C_CHI,COC_MNE_UNI,C0C_MNE_BER,COC_DES,COC_DES_FRM,C0C_FS,C0C_TAB1,COC_DOM,COC_DES_WEB) VALUES (0,'P',null,'XML.W9FLUSSI.W9','W9FLXML','File XML','File XML','A2000',null,'CLOB','File XML');
UPDATE SITATORT.C0CAMPI SET COC_DES='Importo componente forniture al netto sicurezza',COC_DES_WEB='Importo componente forniture al netto sicurezza' where C0C_MNE_BER='W3I_FORNIT';
UPDATE SITATORT.C0CAMPI SET C0C_FS ='N4' WHERE C0C_MNE_BER = 'W3NLOTTO';
UPDATE SITATORT.C0CAMPI SET C0C_FS ='A20' WHERE COC_MNE_UNI = 'CFEIN.UFFINT.GENE';

--- W_OGGETTI
Insert into SITATORT.W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('PAGE','W9.W9INIZ-scheda.SICUREZZA','Pagina Scheda sicurezza',2683);
Insert into SITATORT.W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('PAGE','W9.W9INIZ-scheda.CHECKSICUREZZA','Pagina Misure aggiuntive e migliorative per la sicurezza',2686);

Insert into SITATORT.W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','ALT.W9.W9INBOX-HOME.FLUSSI','Home page Inbox - Sezione Flussi',3540);
Insert into SITATORT.W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','ALT.W9.W9INBOX-HOME.FEEDBACK','Home page Inbox - Sezione Feedback',3545);

--- W_CONFIG
Insert into SITATORT.W_CONFIG (CODAPP, CHIAVE, VALORE) values ('W9', 'registrazione.consentiCreazioneNuovaSA', '1');

UPDATE SITATORT.W_PROFILI SET DESCRIZIONE='Comunicazioni di avvisi per manifestazione di interesse ed altri avvisi' WHERE COD_PROFILO='SA-AVVISI';


UPDATE SITATORT.TAB1 SET TAB1NORD=6 WHERE TAB1COD='W3020' AND TAB1TIP=101;
UPDATE SITATORT.TAB1 SET TAB1NORD=7 WHERE TAB1COD='W3020' AND TAB1TIP=987;
UPDATE SITATORT.TAB1 SET TAB1NORD=8 WHERE TAB1COD='W3020' AND TAB1TIP=1;
UPDATE SITATORT.TAB1 SET TAB1NORD=9 WHERE TAB1COD='W3020' AND TAB1TIP=984;

--- TAB1
UPDATE SITATORT.TAB1 SET TAB1DESC='Manutenzione (Valore non piu'' valido)' where TAB1COD='W3002' and TAB1TIP=11;
Insert into SITATORT.TAB1 (TAB1COD, TAB1TIP, TAB1DESC) values ('W3002', 12, 'Manutenzione Ordinaria');
Insert into SITATORT.TAB1 (TAB1COD, TAB1TIP, TAB1DESC) values ('W3002', 13, 'Manutenzione straordinaria');
Insert into SITATORT.TAB1 (TAB1COD, TAB1TIP, TAB1DESC) values ('W3005', 25, 'Procedura ristretta semplificata');

--TAB2
DELETE FROM SITATORT.TAB2 WHERE TAB2COD='W3z05' AND TAB2TIP IN ('CL','CS');
Update SITATORT.W9LOTT set TIPO_CONTRATTO='L' where TIPO_CONTRATTO='CL';
Update SITATORT.W9LOTT set TIPO_CONTRATTO='S' where TIPO_CONTRATTO='CS';

Update SITATORT.C0CAMPI set COC_DES='Denominazione del soggetto per cui agisce la S.A',COC_DES_WEB='Denominazione del soggetto per cui agisce la S.A' where C0C_MNE_BER='W3GASAAGENTE';
Update SITATORT.C0CAMPI set COC_DES='Codice fiscale del soggetto per cui agisce la S.A',COC_DES_WEB='Codice fiscale del soggetto per cui agisce la S.A' where C0C_MNE_BER='W3GACFAGENTE';

Insert into SITATORT.W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) values ('FUNZ','ALT.W9.INVIISIMOG','Invii a Simog - LoaderAppalto',3550);
Insert into SITATORT.W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) values ('FUNZ','VIS','ALT.W9.INVIISIMOG','Visualizza',0,1,1,1909453922);
Insert into SITATORT.W_AZIONI (TIPO,AZIONE,OGGETTO,DESCR,VALORE,INOR,VISELENCO,CRC) values ('COLS','VIS','W9.W9PERMESSI.CODGARA','Visualizza',0,1,1,71550828);

--- W_CONFIG
INSERT INTO SITATORT.W_CONFIG (CODAPP,CHIAVE,VALORE) VALUES ('W9','it.eldasoft.simog.tipoAccesso',null);
INSERT INTO SITATORT.W_CONFIG (CODAPP,CHIAVE,VALORE) VALUES ('W9','it.eldasoft.simog.ws.url',null);
INSERT INTO SITATORT.W_CONFIG (CODAPP,CHIAVE,VALORE) VALUES ('W9','it.eldasoft.simog.ws.login',null);
INSERT INTO SITATORT.W_CONFIG (CODAPP,CHIAVE,VALORE) VALUES ('W9','it.eldasoft.simog.ws.password',null);
INSERT INTO SITATORT.W_CONFIG (CODAPP,CHIAVE,VALORE) VALUES ('W9','it.eldasoft.simog.loaderAppalto.url',null);

INSERT INTO SITATORT.W_CONFIG (CODAPP,CHIAVE,VALORE) VALUES ('W9','it.eldasoft.sitat.pdd.basicAuth.simogws.username',null);
INSERT INTO SITATORT.W_CONFIG (CODAPP,CHIAVE,VALORE) VALUES ('W9','it.eldasoft.sitat.pdd.basicAuth.simogws.password',null);
INSERT INTO SITATORT.W_CONFIG (CODAPP,CHIAVE,VALORE) VALUES ('W9','it.eldasoft.sitat.pdd.basicAuth.loaderAppalto.username',null);
INSERT INTO SITATORT.W_CONFIG (CODAPP,CHIAVE,VALORE) VALUES ('W9','it.eldasoft.sitat.pdd.basicAuth.loaderAppalto.password',null);


--- Script aggiunti in un secondo momento
------------------------------------------------------------------------------------------------
------------------------         MODIFICA STRUTTURA TABELLE              ------------------------
------------------------------------------------------------------------------------------------
ALTER TABLE SITATORT.W9GARA ADD COLUMN IDCC_BCKP NUMERIC(10);
REORG TABLE SITATORT.W9GARA;

------------------------------------------------------------------------------------------------
------------------------         MODIFICA AI DATI          -------------------------------------
------------------------------------------------------------------------------------------------
UPDATE SITATORT.W9GARA set IDCC_BCKP = IDCC;

INSERT INTO SITATORT.W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','W9.TrovaCentri','Trova Centri di costo',3600);
INSERT INTO SITATORT.W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.W9.TrovaCentri.TROVANUOVO','Nuovo Centro di costo',3603);
INSERT INTO SITATORT.W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','W9.ListaCentri','Lista Centri di costo',3605);
INSERT INTO SITATORT.W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.W9.ListaCentri.DEL','Elimina Centro di costo',3607);
INSERT INTO SITATORT.W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','DEL.W9.ListaCentri.LISTADELSEL','Elimina Centri di costo selezionati',3610);
INSERT INTO SITATORT.W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.W9.ListaCentri.LISTANUOVO','Nuovo Centro di costo',3612);
INSERT INTO SITATORT.W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.W9.ListaCentri.MOD','Modifica Centro di costo',3615);
INSERT INTO SITATORT.W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('MASC','W9.SchedaCentri','Scheda Centri di costo',3617);
INSERT INTO SITATORT.W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','MOD.W9.SchedaCentri.SCHEDAMOD','Modifica Centro di costo',3618);
INSERT INTO SITATORT.W_OGGETTI (TIPO,OGGETTO,DESCR,ORD) VALUES ('FUNZ','INS.W9.SchedaCentri.SCHEDANUOVO','Nuovo Centro di costo',3620);

--- Profilo: ORT-APPA. Centri di costo: no modifica, no inserimento, no cancellazione
INSERT INTO SITATORT.W_PROAZI (COD_PROFILO,TIPO,AZIONE,OGGETTO,VALORE,CRC) VALUES ('ORT-APPA','FUNZ','VIS','INS.W9.TrovaCentri.TROVANUOVO',0,3396902013);
INSERT INTO SITATORT.W_PROAZI (COD_PROFILO,TIPO,AZIONE,OGGETTO,VALORE,CRC) VALUES ('ORT-APPA','FUNZ','VIS','INS.W9.SchedaCentri.SCHEDANUOVO',0,3239673868);
INSERT INTO SITATORT.W_PROAZI (COD_PROFILO,TIPO,AZIONE,OGGETTO,VALORE,CRC) VALUES ('ORT-APPA','FUNZ','VIS','INS.W9.ListaCentri.LISTANUOVO',0,2549356594);
INSERT INTO SITATORT.W_PROAZI (COD_PROFILO,TIPO,AZIONE,OGGETTO,VALORE,CRC) VALUES ('ORT-APPA','FUNZ','VIS','MOD.W9.ListaCentri.MOD',0,2157433065);
INSERT INTO SITATORT.W_PROAZI (COD_PROFILO,TIPO,AZIONE,OGGETTO,VALORE,CRC) VALUES ('ORT-APPA','FUNZ','VIS','MOD.W9.SchedaCentri.SCHEDAMOD',0,914238721);
INSERT INTO SITATORT.W_PROAZI (COD_PROFILO,TIPO,AZIONE,OGGETTO,VALORE,CRC) VALUES ('ORT-APPA','FUNZ','VIS','DEL.W9.ListaCentri.DEL',0,301653945);
INSERT INTO SITATORT.W_PROAZI (COD_PROFILO,TIPO,AZIONE,OGGETTO,VALORE,CRC) VALUES ('ORT-APPA','FUNZ','VIS','DEL.W9.ListaCentri.LISTADELSEL',0,2176608700);

--- Profilo: ORT-PIATRI. Centri di costo: no modifica, no inserimento, no cancellazione
INSERT INTO SITATORT.W_PROAZI (COD_PROFILO,TIPO,AZIONE,OGGETTO,VALORE,CRC) VALUES ('ORT-PIATRI','FUNZ','VIS','INS.W9.TrovaCentri.TROVANUOVO',0,3396902013);
INSERT INTO SITATORT.W_PROAZI (COD_PROFILO,TIPO,AZIONE,OGGETTO,VALORE,CRC) VALUES ('ORT-PIATRI','FUNZ','VIS','INS.W9.ListaCentri.LISTANUOVO',0,2549356594);
INSERT INTO SITATORT.W_PROAZI (COD_PROFILO,TIPO,AZIONE,OGGETTO,VALORE,CRC) VALUES ('ORT-PIATRI','FUNZ','VIS','INS.W9.SchedaCentri.SCHEDANUOVO',0,3239673868);
INSERT INTO SITATORT.W_PROAZI (COD_PROFILO,TIPO,AZIONE,OGGETTO,VALORE,CRC) VALUES ('ORT-PIATRI','FUNZ','VIS','MOD.W9.ListaCentri.MOD',0,2157433065);
INSERT INTO SITATORT.W_PROAZI (COD_PROFILO,TIPO,AZIONE,OGGETTO,VALORE,CRC) VALUES ('ORT-PIATRI','FUNZ','VIS','MOD.W9.SchedaCentri.SCHEDAMOD',0,914238721);
INSERT INTO SITATORT.W_PROAZI (COD_PROFILO,TIPO,AZIONE,OGGETTO,VALORE,CRC) VALUES ('ORT-PIATRI','FUNZ','VIS','DEL.W9.ListaCentri.DEL',0,301653945);
INSERT INTO SITATORT.W_PROAZI (COD_PROFILO,TIPO,AZIONE,OGGETTO,VALORE,CRC) VALUES ('ORT-PIATRI','FUNZ','VIS','DEL.W9.ListaCentri.LISTADELSEL',0,2176608700);

--- Aggiornamento versione di SitatORT
UPDATE SITATORT.ELDAVER SET NUMVER='2.7.2', DATVET=CURRENT TIMESTAMP WHERE CODAPP='W9';
